<!DOCTYPE html>
<html>
  <head>
    <title>Evolución Portafolio - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .chart-container {
        width: 85%;
        margin: 30px auto;
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
      }
      h1 {
        text-align: center;
        font-family: sans-serif;
      }
    </style>
  </head>
  <body>
    <h1>Dashboard: {{ portfolio.name }}</h1>

    <div class="chart-container">
      <h3>Valor Total del Portafolio ($V_t$)</h3>
      <canvas id="canvasVt"></canvas>
    </div>

    <div class="chart-container">
      <h3>Distribución de Pesos ($w_{i,t}$) - Stacked Area</h3>
      <canvas id="canvasWeights"></canvas>
    </div>

    <script>
      async function initDashboard() {
        // 1. Consumimos el endpoint de la API que definiste en urls.py
        // Usamos fechas fijas según la prueba o podrías sacarlas de un input
        const portfolioId = '{{ portfolio.id }}'
        const url = `http://127.0.0.1:8000/investments/api/portfolio/${portfolioId}/history/?fecha_inicio=2022-02-15&fecha_fin=2023-02-16`

        try {
          const response = await fetch(url)
          const data = await response.json()

          const labels = data.map((entry) => entry.date)

          // --- GRÁFICO 1: VALOR TOTAL (LINEA) ---
          new Chart(document.getElementById('canvasVt'), {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                {
                  label: 'Valor Total (USD)',
                  data: data.map((entry) => entry.total_value),
                  borderColor: '#2ecc71',
                  backgroundColor: 'rgba(46, 204, 113, 0.1)',
                  fill: true,
                  tension: 0.1
                }
              ]
            }
          })

          // --- GRÁFICO 2: PESOS (STACKED AREA) ---
          // Extraemos nombres únicos de activos
          const assetNames = [...new Set(data[0].weights.map((w) => w.asset))]

          const weightDatasets = assetNames.map((name, index) => ({
            label: name,
            data: data.map((entry) => {
              const w = entry.weights.find((wi) => wi.asset === name)
              return w ? (w.weight * 100).toFixed(2) : 0
            }),
            fill: true,
            backgroundColor: `hsla(${
              (index * 360) / assetNames.length
            }, 70%, 60%, 0.6)`
          }))

          new Chart(document.getElementById('canvasWeights'), {
            type: 'line',
            data: { labels: labels, datasets: weightDatasets },
            options: {
              scales: {
                y: {
                  stacked: true,
                  max: 100,
                  title: { display: true, text: 'Porcentaje (%)' }
                }
              },
              elements: { point: { radius: 0 } }, // Mejora rendimiento en series largas
              plugins: { legend: { position: 'right' } }
            }
          })
        } catch (error) {
          console.error('Error cargando datos de la API:', error)
        }
      }

      initDashboard()
    </script>
  </body>
</html>
